# Slave 管理功能 - 使用演示

## 功能演示指南

### 1️⃣ 查看 Slave 列表

访问 [http://localhost:3000/slaves](http://localhost:3000/slaves)，你会看到：

- **表格展示**：所有 Slave 服务器的详细信息
- **状态指示**：
  - 🟢 绿色徽章 = 在线
  - 🔴 红色徽章 = 离线
- **实时时间**：顶部显示当前系统时间
- **WebSocket 状态**：
  - 🟢 绿色圆点 = 已连接
  - 🔴 红色圆点 = 已断开

### 2️⃣ 添加新 Slave

**步骤**：

1. 点击右上角 "**添加节点**" 按钮
2. 填写表单：
   ```
   Slave 名称: node-04
   公网 IP/域名: 192.168.1.103
   ```
3. 点击 "**添加**" 按钮
4. 系统自动生成 JWT Token
5. 点击 **复制按钮** 📋 复制 Token
6. Token 示例：
   ```
   eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzbGF2ZV9pZCI6NCwibmFtZSI6Im5vZGUtMDQiLCJleHAiOjE3MDUzMjAwMDB9.xxxxxxxxxxxxx
   ```
7. 点击 "**完成**" 关闭弹窗
8. 新节点出现在列表中

**注意事项**：
- Token 仅显示一次，务必保存
- 将 Token 配置到 Slave 服务器的配置文件中

### 3️⃣ 编辑 Slave 信息

**步骤**：

1. 找到要编辑的 Slave 行
2. 点击 ✏️ **编辑图标**
3. 修改名称或 IP：
   ```
   Slave 名称: node-04-updated
   公网 IP/域名: 192.168.1.104
   ```
4. 点击 "**保存**" 提交更改
5. 列表自动更新

**重新生成 Token**：

1. 在编辑弹窗中点击 "**重新生成 Token**" 按钮
2. 系统生成新 Token 并显示
3. 复制新 Token 并更新 Slave 配置

### 4️⃣ 删除 Slave

**步骤**：

1. 找到要删除的 Slave 行
2. 点击 🗑️ **删除图标**
3. 确认删除对话框：
   ```
   确定要删除 Slave "node-04" 吗？此操作不可恢复。
   ```
4. 点击 "**确定**" 删除
5. 节点从列表中移除

### 5️⃣ 搜索 Slave

**支持的搜索方式**：

- **按名称搜索**：输入 `node-01`
- **按 IP 搜索**：输入 `192.168.1.100`
- **模糊搜索**：输入 `node` 显示所有包含 "node" 的结果

**示例**：
```
搜索框输入: "192.168"
结果: 显示所有 IP 包含 192.168 的节点
```

### 6️⃣ 刷新列表

点击 🔄 **刷新按钮**：
- 按钮显示旋转动画
- 重新从服务器获取最新数据
- 列表自动更新

### 7️⃣ WebSocket 实时更新

**自动更新场景**：

1. **Slave 上线**
   ```
   Slave node-01 启动 → WebSocket 推送消息 → 状态自动变为 🟢 在线
   ```

2. **Slave 下线**
   ```
   Slave node-01 关闭 → WebSocket 推送消息 → 状态自动变为 🔴 离线
   ```

3. **心跳超时**
   ```
   90秒未收到心跳 → Master 检测到 → WebSocket 推送 → 状态变为离线
   ```

**无需刷新页面**，所有状态变更实时反映在列表中。

## UI 交互细节

### Modal 弹窗

- **打开方式**：点击按钮
- **关闭方式**：
  - 点击右上角 ❌ 按钮
  - 点击遮罩层
  - 按 `ESC` 键
  - 点击 "取消" 按钮

### 表单验证

**必填项验证**：
- Slave 名称不能为空
- IP 地址不能为空

**IP 格式验证**：
```
✅ 合法格式:
  - 192.168.1.100
  - 10.0.0.1
  - server.example.com
  - us-node-1.vpn.com

❌ 非法格式:
  - 999.999.999.999
  - invalid-ip
  - 空格或特殊字符
```

### 状态徽章

| 状态 | 徽章颜色 | 图标 |
|------|---------|------|
| 在线 | 🟢 绿色 | ⚡ Activity |
| 离线 | 🔴 红色 | 📡 WifiOff |
| 未知 | 🟡 黄色 | ❓ Help |

### 操作按钮悬停效果

- **编辑按钮**：灰色背景高亮
- **删除按钮**：红色背景高亮
- **所有按钮**：平滑过渡动画（200ms）

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| `ESC` | 关闭 Modal |
| `Ctrl+F` | 聚焦搜索框（浏览器默认） |

## 数据格式说明

### Slave 对象结构

```json
{
  "id": 1,
  "name": "node-01",
  "ip": "192.168.1.100",
  "status": "online",
  "current_version": 5,
  "last_seen": "2026-01-17 20:45:00",
  "uplink": 49006354841,
  "downlink": 132565917286,
  "inbound_count": 3
}
```

### 流量单位换算

- **上行/下行流量**：自动转换为 GB
- 计算方式：`bytes / (1024 * 1024 * 1024)`
- 显示格式：`45.60 GB`

## 常见问题

### Q1: WebSocket 连接失败怎么办？

**症状**：顶部显示 🔴 红色圆点

**解决方案**：
1. 检查后端 Master 服务是否运行（端口 9090）
2. 查看浏览器控制台错误信息
3. 确认 WebSocket 路径正确（`ws://localhost:9090/ws`）
4. 等待自动重连（每 3 秒重试，最多 10 次）

### Q2: 为什么列表没有数据？

**可能原因**：
1. 后端 API 未实现 → 自动使用模拟数据
2. 数据库中没有 Slave 记录
3. API 请求失败 → 查看控制台错误

**验证方法**：
```bash
# 测试 API
curl http://localhost:9090/api/slaves
```

### Q3: Token 复制后如何使用？

**Slave 配置示例**：
```bash
# 启动 Slave 时指定 Token
./slave -master "ws://master-ip:9090/ws" -token "your-jwt-token"
```

### Q4: 实时更新不生效？

**检查步骤**：
1. 确认 WebSocket 已连接（绿色圆点）
2. 打开浏览器开发者工具 → Network → WS 标签
3. 查看是否收到 WebSocket 消息
4. 确认消息格式正确

## 测试场景

### 场景 1: 新增 Slave 完整流程

```
1. 点击 "添加节点"
2. 输入: name="test-node", ip="1.2.3.4"
3. 提交后获得 Token
4. 复制 Token
5. 配置 Slave 服务器
6. 启动 Slave
7. 观察列表自动更新状态为 "在线"
8. 查看流量统计开始增长
```

### 场景 2: WebSocket 实时更新

```
1. 打开 Slave 列表页面
2. 观察 WebSocket 连接状态（绿色）
3. 在服务器上停止某个 Slave 进程
4. 等待 90 秒（心跳超时）
5. 观察前端列表自动更新为 "离线"
6. 重启 Slave
7. 观察状态自动恢复为 "在线"
```

### 场景 3: 搜索和过滤

```
1. 列表中有 5 个节点
2. 搜索框输入 "node-01"
3. 列表只显示 1 个匹配结果
4. 清空搜索框
5. 列表恢复显示全部 5 个节点
```

## 性能指标

- **首次加载时间**：< 1 秒
- **搜索响应时间**：即时（无延迟）
- **WebSocket 重连间隔**：3 秒
- **心跳检测周期**：30 秒
- **列表刷新时间**：< 500ms

## 浏览器兼容性

- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+
- ❌ IE 11（不支持）

---

**提示**：

- 首次使用建议在开发者工具中观察网络请求和 WebSocket 消息
- 所有操作都有控制台日志输出（以 `[SlaveList]` 开头）
- 生产环境建议启用 HTTPS 和 WSS
